#!/bin/bash

# Display help
if [ "$1" == "-h" ] || [ "$1" == "--help" ] ; then
    echo "usage: oprofile OUTPUT_NAME LOCAL_SAVE_DIRECTORY REMOTE_COMMAND"
    exit
fi

# parse arguments
onx_location="/"
output_name="$1" ; shift
output_save_location="$1" ; shift
onx_command="$@"

echo "onx_location: $onx_location"
echo "output_name: $output_name"
echo "output_save_location: $output_save_location"
echo "onx_command: $onx_command"


# Execute given command
cmd="cd $onx_location ; python3 -m cProfile -o /tmp/$output_name $onx_command"
echo "running ONX script"
ssh root@$onx1_IP "$cmd"

# Extract profile output back to local machine
echo "extracting profile output"
cd "$output_save_location"
scp root@"$onx1_IP":/tmp/"$output_name" .

# Start server for visualization on port 5678
snakeviz -s -p 5678 $output_name &

# build up the address for page on the server that we want
IFS="/" read -ra PARTS <<< "$(pwd)"
addr="http://127.0.0.1:5678/snakeviz/%2F"
for part in "${PARTS[@]}"
do
    addr="$addr$part%2F"
done
addr="$addr$output_name"

# sanity check on address
echo "addr: $addr"

# open a reasonable browser to see said page
sensible-browser $addr
